'use strict';

var os = require('os');

var extractPathRegex = /\s+at.*(?:\(|\s)(.*)\)?/;
var pathRegex = /^(?:(?:(?:node|(?:internal\/[\w/]*|.*node_modules\/(?:babel-polyfill|pirates)\/.*)?\w+)\.js:\d+:\d+)|native)/;
var homeDir = typeof os.homedir === 'undefined' ? '' : os.homedir();

module.exports = function (stack, options) {
  options = Object.assign({
    pretty: false
  }, options);
  return stack.replace(/\\/g, '/').split('\n').filter(function (line) {
    var pathMatches = line.match(extractPathRegex);

    if (pathMatches === null || !pathMatches[1]) {
      return true;
    }

    var match = pathMatches[1]; // Electron

    if (match.includes('.app/Contents/Resources/electron.asar') || match.includes('.app/Contents/Resources/default_app.asar')) {
      return false;
    }

    return !pathRegex.test(match);
  }).filter(function (line) {
    return line.trim() !== '';
  }).map(function (line) {
    if (options.pretty) {
      return line.replace(extractPathRegex, function (m, p1) {
        return m.replace(p1, p1.replace(homeDir, '~'));
      });
    }

    return line;
  }).join('\n');
};